@if (blockTimeout()) {
  <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-6 shadow-xl max-w-sm text-center animate-fade-in">
      <h2 class="text-xl font-semibold text-blue-900 mb-4">‚è± –í—Ä–µ–º—è –≤—ã—à–ª–æ</h2>
      <p class="text-gray-700 mb-6">
        –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –±–ª–æ–∫—É —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥...
      </p>
      <button (click)="continueAfterTimeout()"
              class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
        –ü–µ—Ä–µ–π—Ç–∏ —Å–µ–π—á–∞—Å
      </button>
    </div>
  </div>
}

<!-- ‚è± –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ç–µ—Å—Ç–∞ -->
@if (!testStarted() && !testCompleted()) {
  <div class="max-w-2xl mx-auto bg-white p-6 rounded-xl shadow border border-blue-100 mt-10 text-center">
    <h1 class="text-2xl font-semibold text-blue-900 mb-4">{{ test.title }}</h1>
    <p class="text-gray-700 mb-2">{{ test.description }}</p>
    <p class="text-gray-600 mb-4">{{ test.instructions }}</p>
    <button (click)="startTest()"
            class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
      –ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç
    </button>
  </div>
}

<!-- üß© –ù–∞—á–∞–ª–æ –±–ª–æ–∫–∞ -->
@if (testStarted() && block() && !blockStarted() && !testCompleted()) {
  <div class="max-w-xl mx-auto bg-white p-6 rounded-xl shadow border border-blue-100 mt-10 text-center">
    <h1 class="text-xl font-semibold text-blue-900 mb-2">{{ block().name }}</h1>
    <p class="text-gray-700 mb-4">{{ block().instructions }}</p>
    <button (click)="startBlock()"
            class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
      –ù–∞—á–∞—Ç—å –±–ª–æ–∫
    </button>
  </div>
}
@if (block() && block().hasTimeLimit && timeLeft() !== null) {
  <div class="absolute top-0 right-0 bg-blue-100 text-blue-900 px-4 py-2 rounded-bl-xl shadow text-sm font-medium">
    –í—Ä–µ–º–µ–Ω–∏ –Ω–∞ –±–ª–æ–∫ {{ timeLeft() }} —Å–µ–∫
  </div>
}

<!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞ -->
@if (question() && blockStarted()) {
    <div class="w-full max-w-3xl mx-auto mb-6">
    <div class="flex gap-2">
      @for (blockId of blockIds; track blockId) {
        <div
          class="flex-1 h-3 rounded-full relative overflow-hidden transition-all duration-300 border"
          [ngClass]="{
            'border-blue-600 shadow-md': block()?.id === blockId,
            'border-transparent': block()?.id !== blockId
          }"
        >
          <div
            class="absolute inset-0 bg-sky-500 transition-all duration-500"
            [style.width.%]="getBlockProgress(blockId) * 100"
          ></div>
        </div>
      }
    </div>
    <div class="flex justify-between text-xs text-gray-500 mt-1">
      @for (blockId of blockIds; track blockId) {
        <div class="text-center flex-1">
          –ë–ª–æ–∫ {{ blockId }}
        </div>
      }
    </div>
  </div>
  <div class="max-w-3xl mx-auto bg-white p-6 rounded-xl shadow border border-blue-100 mt-10">
    <h2 class="text-lg font-semibold text-blue-800 mb-4">{{ question().text }}</h2>

    @if (question().questionAnswers?.length) {
      <form class="space-y-3">
        @for (answer of question().questionAnswers; track answer.id) {
          <!-- multiple-choice -->
          @if (block().questionsType === 'multiple-choice') {
            <label class="flex items-center space-x-3 text-gray-700">
              <input 
                type="checkbox" 
                id="{{ answer.id }}" 
                name="answer_{{ answer.id }}"
                value="{{ answer.id }}"
                [checked]="selectedAnswers.includes(answer.id.toString())"
                (change)="updateSelectedAnswers($event)" 
                class="accent-blue-600"
              />
              <span>{{ answer.text }}</span>
            </label>
          }

          <!-- single-choice -->
          @if (block().questionsType === 'single-choice') {
            <label class="flex items-center space-x-3 text-gray-700">
              <input 
                type="radio" 
                id="{{ answer.id }}" 
                name="question_{{ question().id }}"
                value="{{ answer.id }}"
                [checked]="selectedAnswers.includes(answer.id.toString())"
                (change)="updateSelectedAnswers($event)" 
                class="accent-blue-600"
              />
              <span>{{ answer.text }}</span>
            </label>
          }
        }
      </form>
    } @else {
      <p class="text-red-500 mt-4">–û—Ç–≤–µ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã ü§∑‚Äç‚ôÄÔ∏è</p>
    }

    <div class="flex justify-between mt-6">
      <button (click)="prev()" class="text-blue-600 hover:underline">–ù–∞–∑–∞–¥</button>
      <button (click)="next()" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700">
        –í–ø–µ—Ä—ë–¥
      </button>
    </div>
  </div>
}

<!-- ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞ -->
@if(testCompleted()) {
  <div class="max-w-2xl mx-auto bg-white p-6 rounded-xl shadow border border-blue-100 mt-10 text-center">
    <p class="text-xl text-blue-900 font-semibold mb-4">–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω üéâ</p>
    <div class="space-x-4 mb-6">
      <button (click)="calculateResults()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
        –ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
      </button>
      <button (click)="saveResults()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
      </button>
    </div>
    <canvas id="testResultsChart" class="mx-auto"></canvas>
  </div>
}
